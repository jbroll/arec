#!/usr/bin/env tclkit8.6
#
#lappend auto_path ../lib

package require tcltest
package require arec

proc iota { fr to { in 1 } } {
    set fr [expr $fr]
    set to [expr $to]
    for { set res {} } { $fr <= $to } { incr fr $in } {lappend res $fr } 
    set res
}


::tcltest::configure -testdir [file dirname [file normalize [info script]]] -singleproc 1  -verbose bps

::tcltest::test rec-dtype-size  { dtype size     } -body { arec::type  size   }		  -result [arec::ARecTypeSize]
::tcltest::test rec-dtype-types { dtype types    } -body { arec::type types   }  	  -result {Tcl_Obj* long long long long long long long long long long}
::tcltest::test rec-dtype-types { dtype types    } -body { arec::type names   }  	  -result {name size align stype nfield afield fields set get shadow inst}
::tcltest::test rec-dtype-types { dtype types    } -body { arec::type fields  }  	  -result {Tcl_Obj* name long size long align long stype long nfield long afield long fields long set long get long shadow long inst}


set Ps [arec::PtrSize]
set Pa [arec::PtrAlign]
set Ls [arec::LngSize]
set La [arec::LngAlign]
set Ds [arec::DblSize]
set Da [arec::DblAlign]

::tcltest::test rec-dtype-size     { dtype size     } -returnCodes 1 -body { arec::types } -result {	::arec::types size  
	::arec::types length  
	::arec::types set  field value ...
	::arec::types setdict  field value ...
	::arec::types setlist  field value ...
	::arec::types get  ?field? ...
	::arec::types getlist  ?field? ...
	::arec::types getdict  ?field? ...
	::arec::types getbytes  
	::arec::types getptr  
	::arec::types setbytes  
::arec::types no method?}
::tcltest::test rec-dtype-size     { dtype size     } -body { arec::types length } 	  		   -result 12
::tcltest::test rec-dtype-types    { dtype types    } -body { arec::types 0 end get name  }  		   -result {char uchar short ushort int uint long ulong float double string Tcl_Obj*}
::tcltest::test rec-dtypes-get     { dtypes get     } -body { arec::types 0 end get     name size align
	} -result [subst {{char 1 1} {uchar 1 1} {short 2 2} {ushort 2 2} {int 4 4} {uint 4 4} {long $Ls $La} {ulong $Ls $La} {float 4 4} {double $Ds $Da} {string $Ps $Pa} {Tcl_Obj* $Ps $Pa}}]
::tcltest::test rec-dtypes-getlist { dtypes getlist } -body { arec::types 0 end getlist name size align
	} -result [subst {{char 1 1} {uchar 1 1} {short 2 2} {ushort 2 2} {int 4 4} {uint 4 4} {long $Ls $La} {ulong $Ls $La} {float 4 4} {double $Ds $Da} {string $Ps $Pa} {Tcl_Obj* $Ps $Pa}}]
::tcltest::test rec-dtypes-getdict { dtypes getdict } -body { arec::types 0 end getdict name size align
	} -result [subst {{name char size 1 align 1} {name uchar size 1 align 1} {name short size 2 align 2} {name ushort size 2 align 2} {name int size 4 align 4} {name uint size 4 align 4} {name long size $Ls align $La} {name ulong size $Ls align $La} {name float size 4 align 4} {name double size $Ds align $Da} {name string size $Ps align $Pa} {name Tcl_Obj* size $Ps align $Pa}}]


foreach type [arec::types 0 end get name] reply { 1 1 1 1 1 1 1 1 1.0 1.0 1 } {
    if { $type eq "Tcl_Obj*" } { continue }

    ::tcltest::test rec-$type "each type: $type" -body {
	arec::typedef blink [subst { $type 	count }]

	blink create blonk 1
	blonk set count 1
	blonk get count
    } -cleanup { rename blink {}; rename blonk {}
    } -result $reply
}


foreach i { 0 1 2 3 4 5 6 7 8 9 0 } {
    ::tcltest::test rec-$i { create type } -body {
	arec::typedef blink {
	    int 	count
	    int 	bunk
	    double  chunk
	}
	blink create blonk 4

	blonk 0 end set count 4
	blonk 0 end set bunk  4
	blonk 0 end set chunk 3.3

	blonk 0 set count 6
	blonk 3 set chunk 5.5


	blonk 0 end get
    } -cleanup { rename blonk {}
    } -result {{6 4 3.3} {4 4 3.3} {4 4 3.3} {4 4 5.5}}
}



::tcltest::test length { length+1 } -body {
    arec::typedef blink {
	double a
	int    b
	double c
    }

    blink create blonk 5

    blonk 0 end set a 3.3
    blonk 0 end set b 3
    blonk 0 end set c 5.5


    blonk end+1 set a 6
    blonk end+1 set a 7
    blonk end+1 set a 8
    blonk end+1 set a 9

    blonk 0 end get
} -cleanup { rename blonk {}
} -result  "[lrepeat 5 {3.3 3 5.5}] {6.0 0 0.0} {7.0 0 0.0} {8.0 0 0.0} {9.0 0 0.0}"

::tcltest::test set1 { set one arg } -body {
    arec::typedef blink {
	double a
	int    b
	double c
    }

    blink create blonk 5
    blonk 0 end set a 1 b 2 c 3
    blonk 0 end set [blonk 0 end get]

    blonk 0 end get
} -cleanup { rename blonk {}
} -result {{1.0 2 3.0} {1.0 2 3.0} {1.0 2 3.0} {1.0 2 3.0} {1.0 2 3.0}}

::tcltest::test setdict { sedict-1 } -body {
    arec::typedef blink {
	double a
	int    b
	double c
    }

    blink create blonk 5
    blonk 0 end set a 1 b 2 c 3
    blonk 0 end setdict [blonk 0 end getdict]

    blonk 0 end getdict
} -cleanup { rename blonk {}
} -result {{a 1.0 b 2 c 3.0} {a 1.0 b 2 c 3.0} {a 1.0 b 2 c 3.0} {a 1.0 b 2 c 3.0} {a 1.0 b 2 c 3.0}}

::tcltest::test setlist { selist-1 } -body {
    arec::typedef blink {
	double a
	int    b
	double c
    }

    blink create blonk 5
    blonk 0 end set a 1 b 2 c 3
    blonk 0 end setlist [blonk 0 end getlist]

    blonk 0 end setlist a b {{1 4} {2 8} {3 12} {4 16} {5 20}}

    blonk 0 end getlist
} -cleanup { rename blonk {}
} -result {{1.0 4 3.0} {2.0 8 3.0} {3.0 12 3.0} {4.0 16 3.0} {5.0 20 3.0}}

::tcltest::test alloc { alloc-1 } -body {
    arec::typedef blink {
	double a
	int    b
	double c
    }

    blink create blonk 0

    foreach i [iota 0 1000] {
	blonk $i set a 1 b 2 c 3
    }
} -cleanup { rename blonk {}
} -result {}

::tcltest::test setlist { selist-1 } -body {
    arec::typedef blink {
	double a
	int    b
	double c
    }

    blink create blonk 5
    lappend reply [blonk 1 get a]
    lappend reply [blonk 1 get a b]
    lappend reply [blonk 1 2 get a]
    lappend reply [blonk 1 2 get a b]

    set reply
} -cleanup { rename blonk {}
} -result {0.0 {0.0 0} {0.0 0.0} {{0.0 0} {0.0 0}}}

::tcltest::test union { union-1 } -body {
    arec::typedef union blink {
	double a
	int    b
	double c
    }

    blink create blonk 1

    blonk 0 set a 4.5
    blonk 0 get a

} -cleanup { rename blonk {}
} -result {4.5}

::tcltest::test union { union-get } -body {
    arec::typedef union blink {
	double a
	int    b
	double c
    }

    blink create blonk 1

    blonk 0 set a 4.5
    set 1 [blonk 0 get]

    blonk 0 set b 4
    set 2 [blonk 0 get]

    list $1 $2

} -cleanup { rename blonk {}
} -result {4.5 4}

::tcltest::test union { union-crunch } -body {
    arec::typedef union blink {
	char    c
	int     i
	short   s
	long    l

	uchar   uc
	uint    ui
	ushort  us
	ulong   ul

	float   f
	double  d

	char*    xchr
	string   xstr
	Tcl_Obj* xobj
    }

    blink create blonk 1

    foreach i [iota 0 100] {
	foreach type { c s i l uc us ui ul f d } {
	    blonk 0 set $type 4
	    blonk 0 set xchr foo
	}
	foreach type { c s i l uc us ui ul f d } {
	    blonk 0 set $type 4
	    blonk 0 set xstr foo
	}
	foreach type { c s i l uc us ui ul f d } {
	    blonk 0 set $type 4
	    blonk 0 set xobj foo
	}
    }

} -cleanup { rename blonk {}
} -result {}

